<!DOCTYPE html>
<html>
	<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="/css/styles.css?1436966512">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='/images/favicon.png' rel='shortcut icon' />
    <meta content='width=device-width, minimum-scale=1.0, maximum-scale=1.0' name='viewport' />
    <title>REDIS lru-cache -- Redis中国用户组（CRUG）</title>
    <meta name="description" content="redis
">
		<script src='/js/jquery-2.0.3.min.js?1426205838'></script>
		<script src='/js/slideout.js?1426205838'></script>
		<script src='/js/app.js?1436878127'></script>
		<script src='/js/base.js?1436878127'></script>
  </head>

<body class=''>
    <div class='mobile-menu slideout-menu'>
      <header class='menu-header'></header>
      <section class='menu-section'>
        <ul class='menu-section-list'>
          <li>
            <a class='home' href='/'>首页</a>
          </li>
          <li>
            <a href='/commands.html'>命令</a>
          </li>
          <li>
            <a href='/clients.html'>客户端</a>
          </li>
          <li>
            <a href='/documentation.html'>文档</a>
          </li>
          <li>
            <a href='/community.html'>社区</a>
          </li>
          <li>
            <a href='/download.html'>下载</a>
          </li>
          <li>
            <a href='/support.html'>支持</a>
          </li>
          <li>
            <a href='/topics/license.html'>许可</a>
          </li>
          <li>
            <a href='/update.html'>更新日志</a>
          </li>
          <li>
            <a href='/articles.html'>文章大全</a>
          </li>
		  <li>
            <a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </li>
          
        </ul>
      </section>
    </div>
    <div class='site-wrapper'>
      <header class='site-header'>
        <nav class='container'>
          <div class='mobile-header'>
            <button class='btn-hamburger js-slideout-toggle'>
              <span class='fa fa-bars'></span>
            </button>
            <a class='home' href='/'>
              <img alt='Redis' src='/images/redis-white.png' />
            </a>
          </div>
          <div class='desktop-header'>
            <a class='home' href='/'>
              <img alt='Redis' src='/images/redis-white.png' />
            </a>
            <a href='/commands.html'>命令</a>
            <a href='/clients.html'>客户端</a>
            <a href='/documentation.html'>文档</a>
            <a href='/community.html'>社区</a>
            <a href='/download.html'>下载</a>
            <a href='/support.html'>支持</a>
            <a href='/topics/license.html'>许可</a>
            <a href='/update.html'>更新日志</a>
            <a href='/articles.html'>文章大全</a>
			<a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </div>
        </nav>
      </header>
      <header class='site-header' style="background-color: #ffffff;">
        <!--
        <nav class='container'>
        	<a href="https://activity.huaweicloud.com/support_plan/index.html?utm_source=huawei&utm_medium=banner&utm_campaign=armredis&utm_content=0624&utm_term=crug" target="_blank">
				<img src="/images/bn/huawei_redis_08.png" style="width:100%;"/>
			</a>
        </nav>
      -->
      </header>
      <div class='site-content'>
<div class='text'>
	<article id='topic'>
		<h1 id="redis延迟监控框架">Redis延迟监控框架</h1>

<p>每个Redis实例经常被用于每时每刻都要提供大量查询服务的场景，同时，对平均响应时间和最大响应延迟的要求都非常严格。</p>

<p>当Redis用作内存系统时，它以不同的方式与操作系统进行交互，例如，持久化数据到磁盘上。再者，Redis实现了丰富的命令集。大部分命令执行都很快，能在确定时间内或对数时间内完成（译者注；对数时间是时间复杂度的一种），另外有些命令则是复杂度为O(N)的命令，会导致延迟毛刺（latency spikes）。</p>

<p>最后，Redis是单线程的：以查看单核处理量的观点来看，单线程通常被认为是优点，并且能够提供延迟的概况，但同时，从延迟本身的观点来看，单线程也会带来挑战，因为单线程只能逐个处理任务，例如，对key过期时间的处理，不会影响到其他客户端。</p>

<p>综上所虑，Redis 2.8.13引入<strong>延迟监控（Latency Monitoring）</strong>的新特性，帮助用户检查和排除可能的延迟问题。延迟监控由以下概念部分组成：</p>

<ul>
  <li>延迟钩子（Latency hooks）：检测不同敏感度延迟的代码路径。</li>
  <li>以不同事件分隔的延迟毛刺的时间序列记录。</li>
  <li>报告引擎：从时间序列记录中提取原始数据。</li>
  <li>分析引擎：提供易懂的报表和按测量结果给出的提示。</li>
</ul>

<p>虽然本文档的余下部分涵盖了延迟监控子系统的很多细节，但更多有关Redis和延迟的主题内容，请阅读<a href="/topics/latency.html">Redis延迟问题诊断</a>。</p>

<h2 id="事件和时间序列">事件和时间序列</h2>

<p>不同监控代码路径有不同的名称，并称之为<em>事件</em>。例如，<code class="language-plaintext highlighter-rouge">command</code>是测量可能很慢的命令的执行延迟毛刺的事件，而<code class="language-plaintext highlighter-rouge">fast-command</code>则是监控时间复杂度为O(1)和O(log N)的命令的事件名称。其他事件则不太通用，主要监控Redis执行的特殊操作。例如，<code class="language-plaintext highlighter-rouge">fork</code>事件仅仅监控Redis执行系统调用<code class="language-plaintext highlighter-rouge">fork(2)</code>所耗的时间。</p>

<p>延迟毛刺是指运行时间比配置的延迟阀值更长的事件。每个监控事件会关联一个独立的时间序列。下面说明时间序列如何工作的：</p>

<ul>
  <li>每次出现延迟毛刺，会记录合适的时间序列</li>
  <li>每个时间序列由160个元素组成</li>
  <li>每个元素是一个值对：包含检测到延迟毛刺出现时的unix时间戳和事件耗时的毫秒数</li>
  <li>相同事件在同一时刻出现多个延迟毛刺，将会被合并（取最大延迟），因此，即使给定事件被检测到出现连续延迟毛刺，例如，由于用户设定了非常低的延迟阀值，将只会保留180秒的历史记录。</li>
  <li>对于每一个元素记录最大的延迟时间。</li>
</ul>

<h2 id="如何启用延迟监控">如何启用延迟监控</h2>

<p>某种用例出现高延迟，对另外的用例可能不会出现高延迟。当一些应用的所有查询的响应延迟都必须少于1毫秒时，而另一些应用的客户端有很小比例出现2秒的延迟，这种情况是可以接受的。</p>

<p>因此，启动延迟监控的第一步是以毫秒为单位设置<strong>延迟阀值（latency threshold）</strong>。仅当事件耗时超过指定的延迟阀值才会记录延迟毛刺。用户可根据需要来设置延迟阀值。例如，如果基于Redis的应用能接受的最大延迟是100毫秒，则延迟阀值应当设置为大于或等于100毫秒，以便记录所有阻塞Redis服务器的事件。</p>

<p>在生产服务器上，通过下面的命令可以在运行时启用延迟监控：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONFIG SET latency-monitor-threshold 100
</code></pre></div></div>

<p>延迟监控默认是关闭状态，即使延迟监控处理几乎不耗时。然而，当延迟监控只需非常小的内存时，则没有必要为一个运行良好的Redis实例提高基线内存使用量（baseline memory usage）。</p>

<h2 id="延迟命令latency的信息报告">延迟命令（LATENCY）的信息报告</h2>

<p>延迟监控子系统的用户界面是<code class="language-plaintext highlighter-rouge">LATENCY</code>命令。像其他Redis命令一样，<code class="language-plaintext highlighter-rouge">LATENCY</code>可以接收子命令来改变命令的行为。接下来的章节对各个子命令进行说明。</p>

<h2 id="latency-latest">LATENCY LATEST</h2>

<p><code class="language-plaintext highlighter-rouge">LATENCY LATEST</code>命令会上报已记录事件的最后一次延迟。每个事件包含以下字段：</p>

<ul>
  <li>事件名称</li>
  <li>事件出现延迟毛刺的Unix时间戳</li>
  <li>最后事件延迟（单位：毫秒）</li>
  <li>本事件的最大延迟（所有时间段）</li>
</ul>

<p>最大事件延迟所指的所有时间段并不是指从Redis实例启动以来，因为事件数据有可能会用稍后看到的<code class="language-plaintext highlighter-rouge">LATENCY RESET</code>命令来重置。</p>

<p>下面是输出样例：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; debug sleep 1
OK
(1.00s)
127.0.0.1:6379&gt; debug sleep .25
OK
127.0.0.1:6379&gt; latency latest
1) 1) "command"
   2) (integer) 1405067976
   3) (integer) 251
   4) (integer) 1001
</code></pre></div></div>

<h2 id="latency-history-event-name">LATENCY HISTORY <code class="language-plaintext highlighter-rouge">event-name</code></h2>

<p><code class="language-plaintext highlighter-rouge">LATENCY HISTORY</code>命令从时间序列中提取原始数据时是非常有用的，数据是“时间戳-延迟”值对的形式。本命令会返回给定事件的160个元素。应用程序可用提取的原始数据来实现性能监控和展示图表等功能。</p>

<p>输出样例：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; latency history command
1) 1) (integer) 1405067822
   2) (integer) 251
2) 1) (integer) 1405067941
   2) (integer) 1001
</code></pre></div></div>

<h2 id="latency-reset-event-name--event-name">LATENCY RESET [<code class="language-plaintext highlighter-rouge">event-name</code> … <code class="language-plaintext highlighter-rouge">event-name</code>]</h2>

<p><code class="language-plaintext highlighter-rouge">LATENCY RESET</code>命令，若不带参数，则重置所有事件，丢弃当前记录的延迟毛刺事件并重置最大事件延迟的值。</p>

<p>通过指定事件名称作为参数，可以重置指定的事件。该命令在执行期间，会返回已被重置的事件时间序列的序号。</p>

<h2 id="latency-graph-event-name">LATENCY GRAPH <code class="language-plaintext highlighter-rouge">event-name</code></h2>

<p>为指定事件生成字符画(ASCII-art style graph)：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; latency reset command
(integer) 0
127.0.0.1:6379&gt; debug sleep .1
OK
127.0.0.1:6379&gt; debug sleep .2
OK
127.0.0.1:6379&gt; debug sleep .3
OK
127.0.0.1:6379&gt; debug sleep .5
OK
127.0.0.1:6379&gt; debug sleep .4
OK
127.0.0.1:6379&gt; latency graph command
command - high 500 ms, low 101 ms (all time high 500 ms)
--------------------------------------------------------------------------------
   #_
  _||
 _|||
_||||

11186
542ss
sss
</code></pre></div></div>

<p>字符画每列下面的垂直标签表示事件是多久之前发生的，可用秒、分钟、小时或天来表示时间单位。例如，”15s”表示上图中第1个图形化的事件发生在15秒钟之前。</p>

<p>图形对最小值和最大值的图例进行了规范化定义，即0表示最小值（即最低一行的下划线），最高一行的#表示最大值。</p>

<p>graph子命令非常有用，能快速判断指定事件的延迟趋势，不需要使用额外的工具，也不需要解析<code class="language-plaintext highlighter-rouge">LATENCY HISTORY</code>命令提供的原始数据。</p>

<h2 id="latency-doctor">LATENCY DOCTOR</h2>

<p><code class="language-plaintext highlighter-rouge">LATENCY DOCTOR</code>命令是最强大的延迟监控分析工具，能提供更多统计数据，如延迟毛刺间的平均时间间隔，中值偏差和易懂的事件分析。对某些事件，如”fork”事件，会提供如系统创建进程的速率等更多的信息。</p>

<p>如果想寻求延迟相关问题的帮助，应当把本命令的输出内容发送到Redis邮件列表。</p>

<p>输出样例：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; latency doctor

Dave，我在Redis实例中已发现延迟毛刺。
您不介意谈论一下，Dave，是吧？

1. command: 5次延迟毛刺（平均 300毫秒，中位偏差 120毫秒，持续时间 73.40秒）。最大事件延迟500毫秒。

我给您如下几点建议：

- 当前配置仅记录比您配置的延迟监控阀值低的事件。请执行命令：'CONFIG SET slowlog-log-slower-than 1000'。
- 检查已记录的日志，以便了解哪些命令的执行特别慢。请访问http://redis.cn/commands/slowlog.html获取更多信息。
- 对大对象进行删除、过期和淘汰操作（由于最大内存策略导致）都属于阻塞操作。如果经常对大对象进行删除、过期和淘汰操作，可尝试把大对象拆分成多个小对象。
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">LATENCY DOCTOR</code>命令目前尚不完善（原意：有精神病行为），因此，我们建议谨慎使用该命令。</p>

	</article>
	
</div>
<script>
		if(isRediscnPc()){
			var s = "_" + Math.random().toString(36).slice(2);
			document.write('<div style="margin-bottom:10px;" id="' + s + '"></div>');
			(window.slotbydup = window.slotbydup || []).push({
				id: "u3556359",
				container:  s
			});
			document.write('<scr'+'ipt type="text/javascr'+'ipt" src="//cpro.baidustatic.com/cpro/ui/c.js" async="async" defer="defer" ></scr'+'ipt>');
		}
	
</script>

<div id='disqus_thread' style="border:1px solid #CDCDCD;background-color:#CDCDCD;"></div>
      <script type='text/javascript'>
      $(document).ready(function(){ 
      		$.get("http://bbs.redis.cn/forum.php?mod=viewthread1&tid=892", function(result){
				    $("#disqus_thread").html(result);
				  });
      });
      </script>
</div>

<footer class='site-footer'>
        <div class='container'>
          本站资源翻译自<a href="http://redis.io" target="_blank">redis.io</a>，
					由<a href="/aboutus.html">redis.cn翻译团队</a>翻译，
					更新日志请点击<a href="/update.html">这里</a>查看，
					翻译原文版权归redis.io官方所有，翻译不正确的地方欢迎大家指出。<br> 
					感谢各界爱心人士的热心捐赠，CRUG的成长离不开大家的帮助和支持，特别是<a href="/donation.html">Redis捐赠清单</a>里面的各位伙伴。<br>
					联系Email:<a href="mailto:admin@redis.cn">admin@redis.cn</a>，
					redis交流群：<a href="#">579708237</a> &nbsp; 
					<a href="https://beian.miit.gov.cn" target="_blank">京ICP备15003959号-2</a> &nbsp;
					<script src='http://s22.cnzz.com/stat.php?id=3593514&web_id=3593514' language='JavaScript'></script>
					<br>    
					<span style="font-weight:bold;color:#000000;">友情链接：</span>
					<a href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=fvilu0rm" target="_blank">阿里云</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">DBA的罗浮宫</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">VIP-陈群博客</a> &nbsp;
					<a href="http://lib.csdn.net/base/redis" target="_blank">Redis-知识库</a> &nbsp;
					<a href="http://www.kubernetes.org.cn" target="_blank" >Kubernetes</a> &nbsp;	
					<a href="https://www.fanghouguo.com" target="_blank" >方后国的博客</a> &nbsp;	
					<a href="https://aff.gae1s.com/aff.php?aff=10022" target="_blank" >ChromeGAE</a> &nbsp;	
					<a href="http://top.chinaz.com/" target="_blank" >网站排行榜</a> &nbsp;	
        </div>
      </footer>
    </div>
  </body>
</html>


<script>
	if(!isMobileBrowser()){
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"54.5"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	}
</script>

<script type='text/javascript'>
lastScrollY=0;

function heartBeat(){ 
	var diffY;
	if (document.documentElement && document.documentElement.scrollTop)
	diffY = document.documentElement.scrollTop;
	else if (document.body)
	diffY = document.body.scrollTop
	else
	{/*Netscape stuff*/}
	//alert(diffY);
	percent=.1*(diffY-lastScrollY); 
	if(percent>0)percent=Math.ceil(percent); 
	else percent=Math.floor(percent); 
	document.getElementById("lovexin12").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	document.getElementById("lovexin14").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	lastScrollY=lastScrollY+percent; 
	//alert(lastScrollY);
}

if(!isMobileBrowser()){
		//suspendcode12="<DIV id=\"lovexin12\" style='width:120px;height:270px;left:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://bbs.huaweicloud.com/forum/thread-16526-1-1.html' target='_blank'><img src='/images/couplets/hw_cp_20190411_01.png'/></a></div>"
		//suspendcode14="<DIV id=\"lovexin14\" style='width:120px;height:270px;right:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://activity.huaweicloud.com/2019june_promotion/index.html?utm_source=huawei&utm_medium=other&utm_campaign=618dacu&utm_content=0614#app-connection' target='_blank'><img src='/images/couplets/hw_cp_20190612.png'/></a></div>"
		//document.write(suspendcode12); 
		//document.write(suspendcode14); 
		//window.setInterval("heartBeat()",1);
}

$(document).ready(function(){ 
	
});
</script>
