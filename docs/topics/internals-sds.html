<!DOCTYPE html>
<html>
	<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="/css/styles.css?1436966512">
    <link rel="stylesheet" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='./images/favicon.png' rel='shortcut icon' />
    <meta content='width=device-width, minimum-scale=1.0, maximum-scale=1.0' name='viewport' />
    <title>REDIS internals-sds -- Redis中国用户组（CRUG）</title>
    <meta name="description" content="redis
">
		<script src='./js/jquery-2.0.3.min.js?1426205838'></script>
		<script src='./js/slideout.js?1426205838'></script>
		<script src='./js/app.js?1436878127'></script>
		<script src='./js/base.js?1436878127'></script>
  </head>

<body class=''>
    <div class='mobile-menu slideout-menu'>
      <header class='menu-header'></header>
      <section class='menu-section'>
        <ul class='menu-section-list'>
          <li>
            <a class='home' src='/'>首页</a>
          </li>
          <li>
            <a href='./commands.html'>命令</a>
          </li>
          <li>
            <a href='./clients.html'>客户端</a>
          </li>
          <li>
            <a href='./documentation.html'>文档</a>
          </li>
          <li>
            <a href='./community.html'>社区</a>
          </li>
          <li>
            <a href='./download.html'>下载</a>
          </li>
          <li>
            <a href='./support.html'>支持</a>
          </li>
          <li>
            <a href='./topics/license.html'>许可</a>
          </li>
          <li>
            <a href='./update.html'>更新日志</a>
          </li>
          <li>
            <a href='./articles.html'>文章大全</a>
          </li>
		  <li>
            <a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </li>
          
        </ul>
      </section>
    </div>
    <div class='site-wrapper'>
      <header class='site-header'>
        <nav class='container'>
          <div class='mobile-header'>
            <button class='btn-hamburger js-slideout-toggle'>
              <span class='fa fa-bars'></span>
            </button>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
          </div>
          <div class='desktop-header'>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
            <a href='./commands.html'>命令</a>
            <a href='./clients.html'>客户端</a>
            <a href='./documentation.html'>文档</a>
            <a href='./community.html'>社区</a>
            <a href='./download.html'>下载</a>
            <a href='./support.html'>支持</a>
            <a href='./topics/license.html'>许可</a>
            <a href='./update.html'>更新日志</a>
            <a href='./articles.html'>文章大全</a>
			<a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </div>
        </nav>
      </header>
      <header class='site-header' style="background-color: #ffffff;">
        <!--
        <nav class='container'>
        	<a href="https://activity.huaweicloud.com/support_plan/index.html?utm_source=huawei&utm_medium=banner&utm_campaign=armredis&utm_content=0624&utm_term=crug" target="_blank">
				<img src="./images/bn/huawei_redis_08.png" style="width:100%;"/>
			</a>
        </nav>
      -->
      </header>
      <div class='site-content'>
<div class='text'>
	<article id='topic'>
		<h1 id="hacking-strings">Hacking Strings</h1>

<p>The implementation of Redis strings is contained in <code class="language-plaintext highlighter-rouge">sds.c</code> (<code class="language-plaintext highlighter-rouge">sds</code> stands for Simple Dynamic Strings).</p>

<p>The C structure <code class="language-plaintext highlighter-rouge">sdshdr</code> declared in <code class="language-plaintext highlighter-rouge">sds.h</code> represents a Redis string:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct sdshdr {
    long len;
    long free;
    char buf[];
};
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">buf</code> character array stores the actual string.</p>

<p>The <code class="language-plaintext highlighter-rouge">len</code> field stores the length of <code class="language-plaintext highlighter-rouge">buf</code>. This makes obtaining the length
of a Redis string an O(1) operation.</p>

<p>The <code class="language-plaintext highlighter-rouge">free</code> field stores the number of additional bytes available for use.</p>

<p>Together the <code class="language-plaintext highlighter-rouge">len</code> and <code class="language-plaintext highlighter-rouge">free</code> field can be thought of as holding the metadata of the <code class="language-plaintext highlighter-rouge">buf</code> character array.</p>

<h2 id="creating-redis-strings">Creating Redis Strings</h2>

<p>A new data type named <code class="language-plaintext highlighter-rouge">sds</code> is defined in <code class="language-plaintext highlighter-rouge">sds.h</code> to be a synonym for a character pointer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef char *sds;
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sdsnewlen</code> function defined in <code class="language-plaintext highlighter-rouge">sds.c</code> creates a new Redis String:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sds sdsnewlen(const void *init, size_t initlen) {
    struct sdshdr *sh;

    sh = zmalloc(sizeof(struct sdshdr)+initlen+1);
#ifdef SDS_ABORT_ON_OOM
    if (sh == NULL) sdsOomAbort();
#else
    if (sh == NULL) return NULL;
#endif
    sh-&gt;len = initlen;
    sh-&gt;free = 0;
    if (initlen) {
        if (init) memcpy(sh-&gt;buf, init, initlen);
        else memset(sh-&gt;buf,0,initlen);
    }
    sh-&gt;buf[initlen] = '\0';
    return (char*)sh-&gt;buf;
}
</code></pre></div></div>

<p>Remember a Redis string is a variable of type <code class="language-plaintext highlighter-rouge">struct sdshdr</code>. But <code class="language-plaintext highlighter-rouge">sdsnewlen</code> returns a character pointer!!</p>

<p>That’s a trick and needs some explanation.</p>

<p>Suppose I create a Redis string using <code class="language-plaintext highlighter-rouge">sdsnewlen</code> like below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sdsnewlen("redis", 5);
</code></pre></div></div>

<p>This creates a new variable of type <code class="language-plaintext highlighter-rouge">struct sdshdr</code> allocating memory for <code class="language-plaintext highlighter-rouge">len</code> and <code class="language-plaintext highlighter-rouge">free</code>
fields as well as for the <code class="language-plaintext highlighter-rouge">buf</code> character array.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh = zmalloc(sizeof(struct sdshdr)+initlen+1); // initlen is length of init argument.
</code></pre></div></div>

<p>After <code class="language-plaintext highlighter-rouge">sdsnewlen</code> successfully creates a Redis string the result is something like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----------
|5|0|redis|
-----------
^   ^
sh  sh-&gt;buf
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sdsnewlen</code> returns <code class="language-plaintext highlighter-rouge">sh-&gt;buf</code> to the caller.</p>

<p>What do you do if you need to free the Redis string pointed by <code class="language-plaintext highlighter-rouge">sh</code>?</p>

<p>You want the pointer <code class="language-plaintext highlighter-rouge">sh</code> but you only have the pointer <code class="language-plaintext highlighter-rouge">sh-&gt;buf</code>.</p>

<p>Can you get the pointer <code class="language-plaintext highlighter-rouge">sh</code> from <code class="language-plaintext highlighter-rouge">sh-&gt;buf</code>?</p>

<p>Yes. Pointer arithmetic. Notice from the above ASCII art that if you subtract
the size of two longs from <code class="language-plaintext highlighter-rouge">sh-&gt;buf</code> you get the pointer <code class="language-plaintext highlighter-rouge">sh</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">sizeof</code> two longs happens to be the size of <code class="language-plaintext highlighter-rouge">struct sdshdr</code>.</p>

<p>Look at <code class="language-plaintext highlighter-rouge">sdslen</code> function and see this trick at work:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>size_t sdslen(const sds s) {
    struct sdshdr *sh = (void*) (s-(sizeof(struct sdshdr)));
    return sh-&gt;len;
}
</code></pre></div></div>

<p>Knowing this trick you could easily go through the rest of the functions in <code class="language-plaintext highlighter-rouge">sds.c</code>.</p>

<p>The Redis string implementation is hidden behind an interface that accepts only character pointers. The users of Redis strings need not care about how its implemented and treat Redis strings as a character pointer.</p>

	</article>
	
</div>
<script>
		if(isRediscnPc()){
			var s = "_" + Math.random().toString(36).slice(2);
			document.write('<div style="margin-bottom:10px;" id="' + s + '"></div>');
			(window.slotbydup = window.slotbydup || []).push({
				id: "u3556359",
				container:  s
			});
			document.write('<scr'+'ipt type="text/javascr'+'ipt" src="//cpro.baidustatic.com/cpro/ui/c.js" async="async" defer="defer" ></scr'+'ipt>');
		}
	
</script>
<footer class='site-footer'>
        <div class='container'>
          本站资源翻译自<a href="http://redis.io" target="_blank">redis.io</a>，
					由<a src="./aboutus.html">redis.cn翻译团队</a>翻译，
					更新日志请点击<a src="./update.html">这里</a>查看，
					翻译原文版权归redis.io官方所有，翻译不正确的地方欢迎大家指出。<br> 
					感谢各界爱心人士的热心捐赠，CRUG的成长离不开大家的帮助和支持，特别是<a src="./donation.html">Redis捐赠清单</a>里面的各位伙伴。<br>
					联系Email:<a href="mailto:admin@redis.cn">admin@redis.cn</a>，
					redis交流群：<a href="#">579708237</a> &nbsp; 
					<a href="https://beian.miit.gov.cn" target="_blank">京ICP备15003959号-2</a> &nbsp;
					<br>    
					<span style="font-weight:bold;color:#000000;">友情链接：</span>
					<a href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=fvilu0rm" target="_blank">阿里云</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">DBA的罗浮宫</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">VIP-陈群博客</a> &nbsp;
					<a href="http://lib.csdn.net/base/redis" target="_blank">Redis-知识库</a> &nbsp;
					<a href="http://www.kubernetes.org.cn" target="_blank" >Kubernetes</a> &nbsp;	
					<a href="https://www.fanghouguo.com" target="_blank" >方后国的博客</a> &nbsp;	
					<a href="https://aff.gae1s.com/aff.php?aff=10022" target="_blank" >ChromeGAE</a> &nbsp;	
					<a href="http://top.chinaz.com/" target="_blank" >网站排行榜</a> &nbsp;	
        </div>
      </footer>
    </div>
  </body>
</html>


<script>
	if(!isMobileBrowser()){
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"54.5"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	}
</script>

<script type='text/javascript'>
lastScrollY=0;

function heartBeat(){ 
	var diffY;
	if (document.documentElement && document.documentElement.scrollTop)
	diffY = document.documentElement.scrollTop;
	else if (document.body)
	diffY = document.body.scrollTop
	else
	{/*Netscape stuff*/}
	//alert(diffY);
	percent=.1*(diffY-lastScrollY); 
	if(percent>0)percent=Math.ceil(percent); 
	else percent=Math.floor(percent); 
	document.getElementById("lovexin12").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	document.getElementById("lovexin14").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	lastScrollY=lastScrollY+percent; 
	//alert(lastScrollY);
}

if(!isMobileBrowser()){
		//suspendcode12="<DIV id=\"lovexin12\" style='width:120px;height:270px;left:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://bbs.huaweicloud.com/forum/thread-16526-1-1.html' target='_blank'><img src='./images/couplets/hw_cp_20190411_01.png'/></a></div>"
		//suspendcode14="<DIV id=\"lovexin14\" style='width:120px;height:270px;right:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://activity.huaweicloud.com/2019june_promotion/index.html?utm_source=huawei&utm_medium=other&utm_campaign=618dacu&utm_content=0614#app-connection' target='_blank'><img src='./images/couplets/hw_cp_20190612.png'/></a></div>"
		//document.write(suspendcode12); 
		//document.write(suspendcode14); 
		//window.setInterval("heartBeat()",1);
}

$(document).ready(function(){ 
	
});
</script>
