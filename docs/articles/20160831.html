<!DOCTYPE html>
<html>
	<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="/css/styles.css?1436966512">
    <link rel="stylesheet" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='./images/favicon.png' rel='shortcut icon' />
    <meta content='width=device-width, minimum-scale=1.0, maximum-scale=1.0' name='viewport' />
    <title>HyperLogLogs in Redis -- Redis中国用户组（CRUG）</title>
    <meta name="description" content="redis
">
		<script src='./js/jquery-2.0.3.min.js?1426205838'></script>
		<script src='./js/slideout.js?1426205838'></script>
		<script src='./js/app.js?1436878127'></script>
		<script src='./js/base.js?1436878127'></script>
  </head>

<body class=''>
    <div class='mobile-menu slideout-menu'>
      <header class='menu-header'></header>
      <section class='menu-section'>
        <ul class='menu-section-list'>
          <li>
            <a class='home' src='/'>首页</a>
          </li>
          <li>
            <a href='./commands.html'>命令</a>
          </li>
          <li>
            <a href='./clients.html'>客户端</a>
          </li>
          <li>
            <a href='./documentation.html'>文档</a>
          </li>
          <li>
            <a href='./community.html'>社区</a>
          </li>
          <li>
            <a href='./download.html'>下载</a>
          </li>
          <li>
            <a href='./support.html'>支持</a>
          </li>
          <li>
            <a href='./topics/license.html'>许可</a>
          </li>
          <li>
            <a href='./update.html'>更新日志</a>
          </li>
          <li>
            <a href='./articles.html'>文章大全</a>
          </li>
		  <li>
            <a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </li>
          
        </ul>
      </section>
    </div>
    <div class='site-wrapper'>
      <header class='site-header'>
        <nav class='container'>
          <div class='mobile-header'>
            <button class='btn-hamburger js-slideout-toggle'>
              <span class='fa fa-bars'></span>
            </button>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
          </div>
          <div class='desktop-header'>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
            <a href='./commands.html'>命令</a>
            <a href='./clients.html'>客户端</a>
            <a href='./documentation.html'>文档</a>
            <a href='./community.html'>社区</a>
            <a href='./download.html'>下载</a>
            <a href='./support.html'>支持</a>
            <a href='./topics/license.html'>许可</a>
            <a href='./update.html'>更新日志</a>
            <a href='./articles.html'>文章大全</a>
			<a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </div>
        </nav>
      </header>
      <header class='site-header' style="background-color: #ffffff;">
        <!--
        <nav class='container'>
        	<a href="https://activity.huaweicloud.com/support_plan/index.html?utm_source=huawei&utm_medium=banner&utm_campaign=armredis&utm_content=0624&utm_term=crug" target="_blank">
				<img src="./images/bn/huawei_redis_08.png" style="width:100%;"/>
			</a>
        </nav>
      -->
      </header>
      <div class='site-content'>
<div class='text'>
	<article id='topic'>
		<p><em>A hyper-what-now?</em></p>

<p>A HyperLogLog is a probabilistic data structure used to count unique values — or as it’s referred to in mathematics: calculating the cardinality of a set.</p>

<p>These values can be anything: for example, IP addresses for the visitors of a website, search terms, or email addresses.</p>

<p>Counting unique values with <em>exact precision</em> requires an amount of memory proportional to the number of unique values. The reason for this is that there is no way of determining if a value has already been seen other than by comparing it to the previously seen values.</p>

<p>Since memory is a limited resource, doing this becomes problematic when working with <em>large sets of values</em>.</p>

<p>A HyperLogLog solves this problem by allowing to trade memory consumption for precision making it possible to estimate cardinalities larger than 109 with a standard error of 2% using only 1.5 kilobytes of memory<a href="https://robots.thoughtbot.com/hyperloglogs-in-redis#1">[1]</a>.</p>

<h2 id="how-to-use-hyperloglogs-in-redis"><a href="https://robots.thoughtbot.com/hyperloglogs-in-redis#how-to-use-hyperloglogs-in-redis">How to use HyperLogLogs in Redis</a></h2>

<p>HyperLogLogs have been available in Redis since version 2.8.9 and are accessed using the <a href="http://redis.io/commands/pfadd"><code class="language-plaintext highlighter-rouge">PFADD</code></a>, <a href="http://redis.io/commands/pfcount"><code class="language-plaintext highlighter-rouge">PFCOUNT</code></a>, and <a href="http://redis.io/commands/pfmerge"><code class="language-plaintext highlighter-rouge">PFMERGE</code></a> commands.</p>

<p>A Redis HyperLogLog consumes at most 12 kilobytes of memory and produces approximations with a standard error of 0.81%. The 12 kilobytes do not include the bytes required to store the actual key.</p>

<p>Ignoring <a href="http://redis.io/commands/pfmerge"><code class="language-plaintext highlighter-rouge">PFMERGE</code></a>, using a HyperLogLog is very similar to using a Set for the same purpose: instead of adding members with <a href="http://redis.io/commands/sadd"><code class="language-plaintext highlighter-rouge">SADD</code></a>, add them with <a href="http://redis.io/commands/pfadd"><code class="language-plaintext highlighter-rouge">PFADD</code></a> and instead of retrieving the cardinality with <a href="http://redis.io/commands/scard"><code class="language-plaintext highlighter-rouge">SCARD</code></a>, retrieve it with <a href="http://redis.io/commands/pfcount"><code class="language-plaintext highlighter-rouge">PFCOUNT</code></a>.</p>

<p>The example below shows the output of an interactive Redis session. You can follow along by running <code class="language-plaintext highlighter-rouge">redis-cli</code> and entering the commands shown on the lines beginning with <code class="language-plaintext highlighter-rouge">&gt;</code>. Make sure an instance of <code class="language-plaintext highlighter-rouge">redis-server</code> is also running.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; PFADD visitors alice bob carol
(integer) 1
&gt; PFCOUNT visitors
(integer) 3
</code></pre></div></div>

<p><a href="http://redis.io/commands/pfadd"><code class="language-plaintext highlighter-rouge">PFADD</code></a> returns <code class="language-plaintext highlighter-rouge">1</code> if the approximated cardinality of the HyperLogLog was changed when adding the element. If not, it returns <code class="language-plaintext highlighter-rouge">0</code>.</p>

<p>After calculating the cardinality, <a href="http://redis.io/commands/pfcount"><code class="language-plaintext highlighter-rouge">PFCOUNT</code></a> will store the calculated value in the last 8 bytes of the HyperLogLog to serve as a cache. This cache is invalidated on the next <a href="http://redis.io/commands/pfadd"><code class="language-plaintext highlighter-rouge">PFADD</code></a>.</p>

<p>The <a href="http://redis.io/commands/pfmerge"><code class="language-plaintext highlighter-rouge">PFMERGE</code></a> command is used to produce a HyperLogLog that approximates the cardinality of the union of two or more existing HyperLogLogs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; PFADD customers alice dan
(integer) 1
&gt; PFMERGE everyone visitors customers
OK
&gt; PFCOUNT everyone
(integer) 4
</code></pre></div></div>

<p>The same result can be achieved by supplying multiple keys to <a href="http://redis.io/commands/pfcount"><code class="language-plaintext highlighter-rouge">PFCOUNT</code></a>. In this case an on-the-fly merge is performed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; PFCOUNT visitors customers
(integer) 4
</code></pre></div></div>

<p>Under the hood, HyperLogLogs are actually stored as strings and can be <a href="http://redis.io/commands/get"><code class="language-plaintext highlighter-rouge">GET</code></a> and <a href="http://redis.io/commands/set"><code class="language-plaintext highlighter-rouge">SET</code></a> as such:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; GET visitors
"HYLL\\x01\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x00E&lt;\\x94X\\x10\\x84Qi\\x8cQD"
&gt; SET visitors "HYLL\\x01\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x00E&lt;\\x94X\\x10\\x84Qi\\x8cQD"
OK
&gt; PFCOUNT visitors
(integer) 3
</code></pre></div></div>

<p>This is useful if the HyperLogLog needs to be persisted elsewhere and later restored.</p>

<p>The <a href="http://redis.io/commands/pfadd"><code class="language-plaintext highlighter-rouge">PFADD</code></a>, <a href="http://redis.io/commands/pfcount"><code class="language-plaintext highlighter-rouge">PFCOUNT</code></a>, and <a href="http://redis.io/commands/pfmerge"><code class="language-plaintext highlighter-rouge">PFMERGE</code></a> commands are prefixed with <code class="language-plaintext highlighter-rouge">PF</code> in memory of <a href="https://en.wikipedia.org/wiki/Philippe_Flajolet">Philippe Flajolet</a>, the inventor of the HyperLogLog algorithm.</p>

<h2 id="the-theory-behind-hyperloglogs"><a href="https://robots.thoughtbot.com/hyperloglogs-in-redis#the-theory-behind-hyperloglogs">The theory behind HyperLogLogs</a></h2>

<p>To get started, let’s look at something more familiar than HyperLogLogs.</p>

<p>Imagine someone flipping a coin multiple times, while recording the maximum number of heads they get in a row. If they told you this number — would you be able to estimate how many times they’d flipped the coin?</p>

<p>Not with great accuracy, but since a longer run of heads is more probable when flipping the coin many times, the number of consecutive heads or tails in a series of coin flips <em>can</em> indicate how many times the coin was flipped: if the number of heads in a row is low, the number of coin flips is most probably <em>also</em> low. Conversely, if the number of heads in a row is high the number of coin flips is most probably high.</p>

<p>If the same number of coin flips were done and recorded separately, a much more precise estimate could be made by combining these numbers. This can be observed using the following methods:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def coin_flips(n)
  Array.new(n) { \[:heads, :tails\].sample }enddef heads\_in\_a_row(flips)
  run = max = 0

  flips.each do |flip|
    if flip == :heads
      run += 1
    else
      max = \[run, max\].max
      run = 0
    end
  end

  maxendclass Array
  def average
    reduce(:+).to_f / size
  endend
</code></pre></div></div>

<p>The bigger the number of coin flips, the bigger the number of heads in a row.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heads\_in\_a\_row coin\_flips(10)    #=&gt; 3heads\_in\_a\_row coin\_flips(100)   #=&gt; 5heads\_in\_a\_row coin\_flips(1000)  #=&gt; 9heads\_in\_a\_row coin\_flips(10000) #=&gt; 15
</code></pre></div></div>

<p>The bigger the number of series, the better the stability of the output. With a more stable output, a better estimate can be made:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heads\_in\_a\_row coin\_flips(10) #=&gt; 3heads\_in\_a\_row coin\_flips(10) #=&gt; 7heads\_in\_a\_row coin\_flips(10) #=&gt; 4Array.new(1000) { heads\_in\_a\_row coin\_flips(10) }.average #=&gt; 2.449Array.new(1000) { heads\_in\_a\_row coin\_flips(10) }.average #=&gt; 2.442Array.new(1000) { heads\_in\_a\_row coin\_flips(10) }.average #=&gt; 2.469
</code></pre></div></div>

<p>Similarly to how the number of coin flips can be estimated by observing the number of heads in a row, the calculations of a HyperLogLog are based on the observation that the cardinality of a set of <em>uniformly distributed random numbers</em> can be estimated by counting the maximum number of leading zeros in the binary representation of the numbers.</p>

<p>For there to <em>be</em> leading zeros, the numbers must be represented as integers with the same number of bits, for instance as 64-bit unsigned integers.</p>

<p>If the maximum number of leading zeros is <em>n</em>, the estimated number of unique values in the set is 2<em>n</em>.</p>

<p>To make sure values are uniformly distributed and represented as same-size integers, the HyperLogLog algorithm applies a hash function to all values. This transforms the values into a set of uniformly distributed random numbers with the same cardinality as the original set.</p>

<p>The first few bits of the hashed values are used to divide them into different subsets, much like the separate series of coin flips in the example above. For each subset the maximum number of leading zeros within its values are stored in a register.</p>

<p>To calculate the approximate cardinality of the whole set, the estimates for all the subsets are combined using a <a href="https://en.wikipedia.org/wiki/Harmonic_mean">harmonic mean</a>.</p>

<h2 id="an-example-use-case"><a href="https://robots.thoughtbot.com/hyperloglogs-in-redis#an-example-use-case">An example use-case</a></h2>

<p>Here’s an example of how to use a Redis HyperLogLog to count unique visitors of a site built with <a href="http://www.sinatrarb.com/">Sinatra</a> using a custom <a href="https://rack.github.io/">Rack</a> middleware:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'redis'require 'sinatra'$redis = Redis.newclass VisitorCounter
  def initialize(app)
    @app = app
  end

  def call(env)
    $redis.pfadd 'visitors', Rack::Request.new(env).ip
    @app.call(env)
  endenduse VisitorCounterget '/' do
  visitors = $redis.pfcount 'visitors'
  "This website has been visited by #{visitors} unique visitors."end
</code></pre></div></div>

<h2 id="references"><a href="https://robots.thoughtbot.com/hyperloglogs-in-redis#references">References</a></h2>

<ol>
  <li>Flajolet, P.; Fusy, E.; Gandouet, O.; Meunier, F. (2007). <a href="http://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf">“HyperLogLog: the analysis of a near-optimal cardinality estimation algorithm”</a>. AOFA ’07: Proceedings of the 2007 International Conference on the Analysis of Algorithms.</li>
</ol>

<h2 id="if-you-enjoyed-this-post-you-might-also-like">If you enjoyed this post, you might also like:</h2>

<ol>
  <li>
    <p><a href="https://robots.thoughtbot.com/how-to-handle-large-amounts-of-data-on-maps">How To Efficiently Display Large Amounts of Data on iOS Maps</a></p>
  </li>
  <li>
    <p><a href="https://robots.thoughtbot.com/arduino-bathroom-occupancy-detector">Arduino-Based Bathroom Occupancy Detector</a></p>
  </li>
  <li>
    <p><a href="https://robots.thoughtbot.com/taming-a-supercar">Taming a Supercar</a></p>
  </li>
</ol>

	</article>
</div>
<footer class='site-footer'>
        <div class='container'>
          本站资源翻译自<a href="http://redis.io" target="_blank">redis.io</a>，
					由<a src="./aboutus.html">redis.cn翻译团队</a>翻译，
					更新日志请点击<a src="./update.html">这里</a>查看，
					翻译原文版权归redis.io官方所有，翻译不正确的地方欢迎大家指出。<br> 
					感谢各界爱心人士的热心捐赠，CRUG的成长离不开大家的帮助和支持，特别是<a src="./donation.html">Redis捐赠清单</a>里面的各位伙伴。<br>
					联系Email:<a href="mailto:admin@redis.cn">admin@redis.cn</a>，
					redis交流群：<a href="#">579708237</a> &nbsp; 
					<a href="https://beian.miit.gov.cn" target="_blank">京ICP备15003959号-2</a> &nbsp;
					<br>    
					<span style="font-weight:bold;color:#000000;">友情链接：</span>
					<a href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=fvilu0rm" target="_blank">阿里云</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">DBA的罗浮宫</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">VIP-陈群博客</a> &nbsp;
					<a href="http://lib.csdn.net/base/redis" target="_blank">Redis-知识库</a> &nbsp;
					<a href="http://www.kubernetes.org.cn" target="_blank" >Kubernetes</a> &nbsp;	
					<a href="https://www.fanghouguo.com" target="_blank" >方后国的博客</a> &nbsp;	
					<a href="https://aff.gae1s.com/aff.php?aff=10022" target="_blank" >ChromeGAE</a> &nbsp;	
					<a href="http://top.chinaz.com/" target="_blank" >网站排行榜</a> &nbsp;	
        </div>
      </footer>
    </div>
  </body>
</html>


<script>
	if(!isMobileBrowser()){
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"54.5"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	}
</script>

<script type='text/javascript'>
lastScrollY=0;

function heartBeat(){ 
	var diffY;
	if (document.documentElement && document.documentElement.scrollTop)
	diffY = document.documentElement.scrollTop;
	else if (document.body)
	diffY = document.body.scrollTop
	else
	{/*Netscape stuff*/}
	//alert(diffY);
	percent=.1*(diffY-lastScrollY); 
	if(percent>0)percent=Math.ceil(percent); 
	else percent=Math.floor(percent); 
	document.getElementById("lovexin12").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	document.getElementById("lovexin14").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	lastScrollY=lastScrollY+percent; 
	//alert(lastScrollY);
}

if(!isMobileBrowser()){
		//suspendcode12="<DIV id=\"lovexin12\" style='width:120px;height:270px;left:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://bbs.huaweicloud.com/forum/thread-16526-1-1.html' target='_blank'><img src='./images/couplets/hw_cp_20190411_01.png'/></a></div>"
		//suspendcode14="<DIV id=\"lovexin14\" style='width:120px;height:270px;right:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://activity.huaweicloud.com/2019june_promotion/index.html?utm_source=huawei&utm_medium=other&utm_campaign=618dacu&utm_content=0614#app-connection' target='_blank'><img src='./images/couplets/hw_cp_20190612.png'/></a></div>"
		//document.write(suspendcode12); 
		//document.write(suspendcode14); 
		//window.setInterval("heartBeat()",1);
}

$(document).ready(function(){ 
	
});
</script>
