<!DOCTYPE html>
<html>
	<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="/css/styles.css?1436966512">
    <link rel="stylesheet" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='./images/favicon.png' rel='shortcut icon' />
    <meta content='width=device-width, minimum-scale=1.0, maximum-scale=1.0' name='viewport' />
    <title>使用Golang和Redis的分布式锁 -- Redis中国用户组（CRUG）</title>
    <meta name="description" content="redis
">
		<script src='./js/jquery-2.0.3.min.js?1426205838'></script>
		<script src='./js/slideout.js?1426205838'></script>
		<script src='./js/app.js?1436878127'></script>
		<script src='./js/base.js?1436878127'></script>
  </head>

<body class=''>
    <div class='mobile-menu slideout-menu'>
      <header class='menu-header'></header>
      <section class='menu-section'>
        <ul class='menu-section-list'>
          <li>
            <a class='home' src='/'>首页</a>
          </li>
          <li>
            <a href='./commands.html'>命令</a>
          </li>
          <li>
            <a href='./clients.html'>客户端</a>
          </li>
          <li>
            <a href='./documentation.html'>文档</a>
          </li>
          <li>
            <a href='./community.html'>社区</a>
          </li>
          <li>
            <a href='./download.html'>下载</a>
          </li>
          <li>
            <a href='./support.html'>支持</a>
          </li>
          <li>
            <a href='./topics/license.html'>许可</a>
          </li>
          <li>
            <a href='./update.html'>更新日志</a>
          </li>
          <li>
            <a href='./articles.html'>文章大全</a>
          </li>
		  <li>
            <a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </li>
          
        </ul>
      </section>
    </div>
    <div class='site-wrapper'>
      <header class='site-header'>
        <nav class='container'>
          <div class='mobile-header'>
            <button class='btn-hamburger js-slideout-toggle'>
              <span class='fa fa-bars'></span>
            </button>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
          </div>
          <div class='desktop-header'>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
            <a href='./commands.html'>命令</a>
            <a href='./clients.html'>客户端</a>
            <a href='./documentation.html'>文档</a>
            <a href='./community.html'>社区</a>
            <a href='./download.html'>下载</a>
            <a href='./support.html'>支持</a>
            <a href='./topics/license.html'>许可</a>
            <a href='./update.html'>更新日志</a>
            <a href='./articles.html'>文章大全</a>
			<a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </div>
        </nav>
      </header>
      <header class='site-header' style="background-color: #ffffff;">
        <!--
        <nav class='container'>
        	<a href="https://activity.huaweicloud.com/support_plan/index.html?utm_source=huawei&utm_medium=banner&utm_campaign=armredis&utm_content=0624&utm_term=crug" target="_blank">
				<img src="./images/bn/huawei_redis_08.png" style="width:100%;"/>
			</a>
        </nav>
      -->
      </header>
      <div class='site-content'>
<div class='text'>
	<article id='topic'>
		<p>Maintaining locks across a cluster of application instances, be it multiple threads on the same server, or different servers altogether, is an often underestimated component of developing clustered applications (be it Golang or other languages and frameworks). It’s relatively straightforward but there are some gotchas to look out for when implementing your distributed locking mechanisms.</p>

<h1 id="whats-distributed-locking">What’s Distributed Locking?</h1>

<p>Distributed locks are a means to ensure that multiple processes can utilize a shared resource in a mutually exclusive way, meaning that only one can make use of the resource at a time. They are quite similar to the concept of a mutex, however in the case of distributed locks, the locking mechanism is intended for processes that may or may not be operating in the same machine or application.</p>

<p>Let’s say for example that you’re writing some software that has a daily job to charge customers who’s subscription is renewing that day. You have multiple instances of your billing application running in order to process the payments quickly, but you need to make sure that two (or more) instances don’t pick up the same user, and double bill them. In this case the user is the shared resource that must be accessed by only a single process.</p>

<p>What you need is something for the two billing application instances, let’s call them <strong>Billing A</strong> and <strong>Billing B</strong>, to coordinate with (we’ll call this the <strong>Coordinator</strong>) that can definitively say that one of them is good to go, and the other needs to skip that user. The process looks like this:</p>

<p>    <img src="https://kylewbanks.com/images/post/distributed-locks-1.png" alt="" /></p>

<p>As you can see, <strong>Billing A</strong> and <strong>Billing B</strong> both ask the <strong>Coordinator</strong> if they can process the same user, User X. The Coordinator ensures that only one, <strong>Billing A</strong>, gets the go ahead, and the <strong>Billing B</strong> has to skip the user.</p>

<h1 id="using-redis">Using Redis</h1>

<p>Redis is a prime (and popular) candidate for the <strong>Coordinator</strong> job due to it’s single-threaded nature, and it’s ability to perform atomic operations. The official documentation contains a wealth of information on this topic, and provides us with the exact commands we need in order to turn our Redis instance into a <strong>Coordinator</strong>.</p>

<p>In order to request a lock on a particular resource, we do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET resource_name unique_value NX PX duration
</code></pre></div></div>

<p>The <strong>resource_name</strong> is a value that all instances of your application would share. In the case above it could be the user’s identifier, such as a primary key ID or username, for example. The <strong>unique_value</strong> is something that must be unique to each instance of your application, such as a UUID. The purpose of this unique value is to allow the application instance that successfully locked the resource to have exclusive access to modify, extend, or remove the lock (unlock), similar to a password or key. Finally we also provide a duration (in milliseconds), after which the lock will be automatically removed by Redis.</p>

<p>Speaking of unlocking, when we no longer need a lock on the resource, we can unlock it like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if redis.call("get", resource_name) == unique_value then
    return redis.call("del", resource_name)
else
    return 0
end
</code></pre></div></div>

<p>Basically what we do here is <strong>get</strong> the <strong>resource_name</strong> and ensure it’s value matches the <strong>unique_value</strong> we stored earlier. This ensures we don’t accidentally delete another instance’s lock. If the <strong>unique_value</strong> does match, we go ahead and delete the lock, otherwise we simply return <strong>0</strong> to signal that the unlock attempt was unsuccessful.</p>

<h1 id="implementation">Implementation</h1>

<p>Implementing this locking mechanism in Go is fairly straightforward once you understand the Redis scripts above. For the examples below, I’ll be using the popular <a href="https://github.com/garyburd/redigo">Redigo</a> Redis client for Go, but the concept is the same regardless of language or client.</p>

<p>The first thing we’ll do is define the scripts:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const (
	lockScript = `
		return redis.call('SET', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2])
	`
	unlockScript = `
		if redis.call("get",KEYS[1]) == ARGV[1] then
		    return redis.call("del",KEYS[1])
		else
		    return 0
		end
	`
)
</code></pre></div></div>

<p>And we can then utilize them like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Lock attempts to put a lock on the key for a specified duration (in milliseconds).
// If the lock was successfully acquired, true will be returned.
func Lock(key, value string, timeoutMs int) (bool, error) {
	r := pool.Get()
	defer r.Close()

	cmd := redis.NewScript(1, lockScript)
	if res, err := cmd.Do(r, key, value, timeoutMs); err != nil {
		return false, err
	} else {
		return res == "OK", nil
	}
}

// Unlock attempts to remove the lock on a key so long as the value matches.
// If the lock cannot be removed, either because the key has already expired or
// because the value was incorrect, an error will be returned.
func Unlock(key, value string) error {
	r := pool.Get()
	defer r.Close()

	cmd := redis.NewScript(1, unlockScript)
	if res, err := redis.Int(cmd.Do(r, key, value)); err != nil {
		return err
	} else if res != 1 {
		return errors.New("Unlock failed, key or secret incorrect")
	}
	
	// Success
	return nil
}
</code></pre></div></div>

<p>In these two functions, <strong>key</strong> and <strong>value</strong> are synonymous with the <strong>resource_name</strong> and <strong>unique_value</strong> above. <strong>Lock</strong> will return a boolean indicating if the lock was acquired, allowing us to proceed with our application logic accordingly.</p>

<p>Going back to the billing application example, when our billing service runs it simply calls <strong>Lock</strong> before processing the user, and only proceeds if <strong>Lock</strong> returns <strong>true</strong>. When it’s done processing, it can then call <strong>Unlock</strong> to release the lock:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func Bill(u User) {
    uniqueValue := "a unique value"
    
    if isLocked, _ := Lock(u.Username, uniqueValue, LockDuration); !isLocked {
        continue
    }
    defer Unlock(u.Username, uniqueValue)
    
    // Perform billing logic...
}
</code></pre></div></div>

<p>Note that I’m intentionally ignoring errors here for the sake of brevity.</p>

<p>As you can see, if the lock doesn’t succeed, we simply skip the user and move on to the next. If the lock is successful, we <a href="https://kylewbanks.com/blog/when-to-use-defer-in-go">defer unlocking</a> to ensure it’s run before the function returns, and proceed to bill the user. This gives us peace of mind in knowing that the user will only be charged once no matter how many instances of our billing application are simultaneously attempting to bill the user.</p>

<h1 id="multiple-redis-instances">Multiple Redis Instances</h1>

<p>Now there is one caveat to the implementation here, in that it only works when there is a single Redis instance. When running Redis in a cluster, a more sophisticated approach is necessary and you can read more about that in the official <a href="http://redis.io/topics/distlock">Redis documentation</a>.</p>

	</article>
</div>
<footer class='site-footer'>
        <div class='container'>
          本站资源翻译自<a href="http://redis.io" target="_blank">redis.io</a>，
					由<a src="./aboutus.html">redis.cn翻译团队</a>翻译，
					更新日志请点击<a src="./update.html">这里</a>查看，
					翻译原文版权归redis.io官方所有，翻译不正确的地方欢迎大家指出。<br> 
					感谢各界爱心人士的热心捐赠，CRUG的成长离不开大家的帮助和支持，特别是<a src="./donation.html">Redis捐赠清单</a>里面的各位伙伴。<br>
					联系Email:<a href="mailto:admin@redis.cn">admin@redis.cn</a>，
					redis交流群：<a href="#">579708237</a> &nbsp; 
					<a href="https://beian.miit.gov.cn" target="_blank">京ICP备15003959号-2</a> &nbsp;
					<br>    
					<span style="font-weight:bold;color:#000000;">友情链接：</span>
					<a href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=fvilu0rm" target="_blank">阿里云</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">DBA的罗浮宫</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">VIP-陈群博客</a> &nbsp;
					<a href="http://lib.csdn.net/base/redis" target="_blank">Redis-知识库</a> &nbsp;
					<a href="http://www.kubernetes.org.cn" target="_blank" >Kubernetes</a> &nbsp;	
					<a href="https://www.fanghouguo.com" target="_blank" >方后国的博客</a> &nbsp;	
					<a href="https://aff.gae1s.com/aff.php?aff=10022" target="_blank" >ChromeGAE</a> &nbsp;	
					<a href="http://top.chinaz.com/" target="_blank" >网站排行榜</a> &nbsp;	
        </div>
      </footer>
    </div>
  </body>
</html>


<script>
	if(!isMobileBrowser()){
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"54.5"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	}
</script>

<script type='text/javascript'>
lastScrollY=0;

function heartBeat(){ 
	var diffY;
	if (document.documentElement && document.documentElement.scrollTop)
	diffY = document.documentElement.scrollTop;
	else if (document.body)
	diffY = document.body.scrollTop
	else
	{/*Netscape stuff*/}
	//alert(diffY);
	percent=.1*(diffY-lastScrollY); 
	if(percent>0)percent=Math.ceil(percent); 
	else percent=Math.floor(percent); 
	document.getElementById("lovexin12").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	document.getElementById("lovexin14").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	lastScrollY=lastScrollY+percent; 
	//alert(lastScrollY);
}

if(!isMobileBrowser()){
		//suspendcode12="<DIV id=\"lovexin12\" style='width:120px;height:270px;left:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://bbs.huaweicloud.com/forum/thread-16526-1-1.html' target='_blank'><img src='./images/couplets/hw_cp_20190411_01.png'/></a></div>"
		//suspendcode14="<DIV id=\"lovexin14\" style='width:120px;height:270px;right:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://activity.huaweicloud.com/2019june_promotion/index.html?utm_source=huawei&utm_medium=other&utm_campaign=618dacu&utm_content=0614#app-connection' target='_blank'><img src='./images/couplets/hw_cp_20190612.png'/></a></div>"
		//document.write(suspendcode12); 
		//document.write(suspendcode14); 
		//window.setInterval("heartBeat()",1);
}

$(document).ready(function(){ 
	
});
</script>
