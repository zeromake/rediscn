<!DOCTYPE html>
<html>
	<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="/css/styles.css?1436966512">
    <link rel="stylesheet" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='./images/favicon.png' rel='shortcut icon' />
    <meta content='width=device-width, minimum-scale=1.0, maximum-scale=1.0' name='viewport' />
    <title>Redis 数据自动清理 - CNode技术社区 -- Redis中国用户组（CRUG）</title>
    <meta name="description" content="redis
">
		<script src='./js/jquery-2.0.3.min.js?1426205838'></script>
		<script src='./js/slideout.js?1426205838'></script>
		<script src='./js/app.js?1436878127'></script>
		<script src='./js/base.js?1436878127'></script>
  </head>

<body class=''>
    <div class='mobile-menu slideout-menu'>
      <header class='menu-header'></header>
      <section class='menu-section'>
        <ul class='menu-section-list'>
          <li>
            <a class='home' src='/'>首页</a>
          </li>
          <li>
            <a href='./commands.html'>命令</a>
          </li>
          <li>
            <a href='./clients.html'>客户端</a>
          </li>
          <li>
            <a href='./documentation.html'>文档</a>
          </li>
          <li>
            <a href='./community.html'>社区</a>
          </li>
          <li>
            <a href='./download.html'>下载</a>
          </li>
          <li>
            <a href='./support.html'>支持</a>
          </li>
          <li>
            <a href='./topics/license.html'>许可</a>
          </li>
          <li>
            <a href='./update.html'>更新日志</a>
          </li>
          <li>
            <a href='./articles.html'>文章大全</a>
          </li>
		  <li>
            <a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </li>
          
        </ul>
      </section>
    </div>
    <div class='site-wrapper'>
      <header class='site-header'>
        <nav class='container'>
          <div class='mobile-header'>
            <button class='btn-hamburger js-slideout-toggle'>
              <span class='fa fa-bars'></span>
            </button>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
          </div>
          <div class='desktop-header'>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
            <a href='./commands.html'>命令</a>
            <a href='./clients.html'>客户端</a>
            <a href='./documentation.html'>文档</a>
            <a href='./community.html'>社区</a>
            <a href='./download.html'>下载</a>
            <a href='./support.html'>支持</a>
            <a href='./topics/license.html'>许可</a>
            <a href='./update.html'>更新日志</a>
            <a href='./articles.html'>文章大全</a>
			<a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </div>
        </nav>
      </header>
      <header class='site-header' style="background-color: #ffffff;">
        <!--
        <nav class='container'>
        	<a href="https://activity.huaweicloud.com/support_plan/index.html?utm_source=huawei&utm_medium=banner&utm_campaign=armredis&utm_content=0624&utm_term=crug" target="_blank">
				<img src="./images/bn/huawei_redis_08.png" style="width:100%;"/>
			</a>
        </nav>
      -->
      </header>
      <div class='site-content'>
<div class='text'>
	<article id='topic'>
		<h1 id="redis-数据清理">Redis 数据清理</h1>

<p>本模块是 <a href="https://github.com/shudingbo/sdb-schedule">sdb-schedule</a> 的插件，用于自动清理 redis 数据。 sdb-schedule 也提供了APP <a href="https://github.com/shudingbo/sdb-schedule-ui">sdb-schedule-ui</a>，进行图形化操作。 可在这里进行下载 <a href="https://github.com/shudingbo/sdb-public/blob/master/sdb-schedule-ui/sdb-schedule-ui.7z">download</a>。</p>

<ul>
  <li>
    <p>支持 正则表达式</p>
  </li>
  <li>
    <p>支持 ZSET,LIST 的清理</p>
  </li>
</ul>

<p><img src="https://github.com/shudingbo/sdb-public/blob/master/sdb-schedule-ui/setting.jpg" alt="Setting" title="Setting" /></p>

<h2 id="安装">安装</h2>

<h3 id="step-1-install-module">step 1: install module</h3>

<p>Using npm:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm install scp-cleanRedis
</code></pre></div></div>

<h3 id="step-2-config-in-sdb-schedule">step 2: config in sdb-schedule</h3>

<ul>
  <li>添加 Job，设置 Fun 参数为 “scp-cleanRedis”.</li>
</ul>

<h2 id="更新记录">更新记录</h2>

<h3 id="002">0.0.2</h3>

<p>修复只能清理一次的Bug。</p>

<h3 id="001">0.0.1</h3>

<p>实现功能。</p>

<h2 id="配置">配置</h2>

<p>配置文件采用json格式，定义了每个匹配，结构大致如下:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {
	"redis":{ "host":"127.0.0.1","port":6379 },
	"keys":\[
		{
			"name":"&lt;descript info&gt;",
			"type":"&lt;zset|list|key&gt;",
			"match":"&lt;redis keys synctax&gt;",
			"action":{
				"style" : "&lt;rank|score|rem|trim&gt;",  // rank|score for ZSET;rem|trim for LIST
				"min"   : "&lt;js expression&gt;",
				"max"   : "&lt;js expression&gt;",
				"count" : "&lt;js expression&gt;", // optional ,FOR LIST rem
				"value" : "&lt;js expression&gt;", // optional ,FOR LIST rem
				"expire":36000,    // optional, for key type

				"regex":"&lt;regex&gt;",
				"attr":\[
					{
						"matchType":"&lt;int|string|dateStamp&gt;",
						"min"    : "&lt;val0 | js expression&gt;",
						"max"    : "\[val0 | js expression\]"
					}
				\]
			}
		}
	\]};
</code></pre></div></div>

<h3 id="redis">redis</h3>

<p>配置操作的redis数据库的地址</p>

<ul>
  <li>
    <p>host, redis服务器的IP；</p>
  </li>
  <li>
    <p>port, redis服务器的端口号；</p>
  </li>
</ul>

<h3 id="keys">keys</h3>

<p>数组，清理的redis键的配置。</p>

<ul>
  <li>
    <p>name,清理操作描述信息</p>
  </li>
  <li>
    <p>type,清理类型</p>
  </li>
  <li>
    <p>zset,清理 ZSET 数据</p>
  </li>
  <li>
    <p>list，清理 LIST 数据</p>
  </li>
  <li>
    <p>key，清理redis key,通过设置超期值来实现</p>
  </li>
  <li>
    <p>match，查找匹配的redis键，参照 redis keys 的语法。</p>
  </li>
  <li>
    <p>action，操作</p>
  </li>
  <li>
    <p>matchType，匹配类型，支持整形(int)，字符串(string)，时间戳(dateStamp)</p>
  </li>
  <li>
    <p>min，匹配范围低值</p>
  </li>
  <li>
    <p>max，匹配范围高值，对 string类型无效</p>
  </li>
  <li>
    <p>rank，type为 <em>ZSET</em> 时有效，对应调用 <em>zremrangebyrank</em> 实现数据的清理</p>
  </li>
  <li>
    <p>score,type为 <em>ZSET</em> 时有效，对应调用 <em>zremrangebyscore</em> 实现数据的清理</p>
  </li>
  <li>
    <p>rem，type为 <em>LIST</em> 时有效，对应调用 <em>lrem</em> 实现数据的清理</p>
  </li>
  <li>
    <p>trim，type为 <em>LIST</em> 时有效，对应调用 <em>ltrim</em> 实现数据的清理</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>style，操作的方式,支持 ( rank</td>
          <td>score</td>
          <td>rem</td>
          <td>trim )。</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>min，js表达式，移除范围低值，用于 ZSET 和 LIST 的 trim</p>
  </li>
  <li>
    <p>max，js表达式，移除范围高值，用于 ZSET 和 LIST 的 trim</p>
  </li>
  <li>
    <p>count，js表达式，移除数量，用于 LIST 的 rem</p>
  </li>
  <li>
    <p>value，js表达式，移除数值，用于 LIST 的 rem</p>
  </li>
  <li>
    <p>expire, 数字，单位秒， type为key时有效，设置 key 的超期值</p>
  </li>
  <li>
    <p>regex， 键的匹配正则表达式，支持子匹配，子匹配的匹配判断参数在 下面的 attr里面设置</p>
  </li>
  <li>attr, 子匹配属性</li>
</ul>

<p>下面是配置的详细例子</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
	"redis":{ "host":"127.0.0.1","port":6379 },
	"keys":\[
		{
			"name":"清理zset类型",
			"type":"zset",
			"match":"*:Pool:his",
			"action":{
				"style" : "score",
				"min"   : "'-inf'",
				"max"   : "parseInt((new Date()).valueOf()/1000) - 86400 * 30",
				"regex":"(\[0-9\]{8}):*",
				"attr":\[
					{
						"matchType":"string",
						"min"    : "50901800",
						"max"    : ""
					}
				\]
			}
		},
		{
			"name":"清理 List",
			"type":"list",
			"match":"brnn:winls",
			"action":{
				"style":"trim",
				"min"  : 0,
				"max"  : 3
			}
		},
		{
			"name":"清理key",
			"type":"key",
			"match":"rcard:20??????:*:*",
			"action":{
				"expire":36000,
				"regex":"(\[0-9\]{8}):(\[0-9\]{1,}):(\[0-9\]{1,})",
				"attr":\[
					{
						"matchType":"dateStamp",
						"min"    : "0",
						"max"    : "(new Date()).valueOf() - 86400 * 30000"
					},
					{
						"matchType":"int",
						"min"    : "0",
						"max"    : "3"
					},
					{
						"matchType":"string",
						"min"    : "5",
						"max"    : ""
					}
				\]
			}
		}
	\]};
</code></pre></div></div>

<h2 id="copyright-and-license">Copyright and license</h2>

<p>Copyright 2016+ shudingbo</p>

<p>Licensed under the [MIT License].</p>

	</article>
</div>
<footer class='site-footer'>
        <div class='container'>
          本站资源翻译自<a href="http://redis.io" target="_blank">redis.io</a>，
					由<a src="./aboutus.html">redis.cn翻译团队</a>翻译，
					更新日志请点击<a src="./update.html">这里</a>查看，
					翻译原文版权归redis.io官方所有，翻译不正确的地方欢迎大家指出。<br> 
					感谢各界爱心人士的热心捐赠，CRUG的成长离不开大家的帮助和支持，特别是<a src="./donation.html">Redis捐赠清单</a>里面的各位伙伴。<br>
					联系Email:<a href="mailto:admin@redis.cn">admin@redis.cn</a>，
					redis交流群：<a href="#">579708237</a> &nbsp; 
					<a href="https://beian.miit.gov.cn" target="_blank">京ICP备15003959号-2</a> &nbsp;
					<br>    
					<span style="font-weight:bold;color:#000000;">友情链接：</span>
					<a href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=fvilu0rm" target="_blank">阿里云</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">DBA的罗浮宫</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">VIP-陈群博客</a> &nbsp;
					<a href="http://lib.csdn.net/base/redis" target="_blank">Redis-知识库</a> &nbsp;
					<a href="http://www.kubernetes.org.cn" target="_blank" >Kubernetes</a> &nbsp;	
					<a href="https://www.fanghouguo.com" target="_blank" >方后国的博客</a> &nbsp;	
					<a href="https://aff.gae1s.com/aff.php?aff=10022" target="_blank" >ChromeGAE</a> &nbsp;	
					<a href="http://top.chinaz.com/" target="_blank" >网站排行榜</a> &nbsp;	
        </div>
      </footer>
    </div>
  </body>
</html>


<script>
	if(!isMobileBrowser()){
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"54.5"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	}
</script>

<script type='text/javascript'>
lastScrollY=0;

function heartBeat(){ 
	var diffY;
	if (document.documentElement && document.documentElement.scrollTop)
	diffY = document.documentElement.scrollTop;
	else if (document.body)
	diffY = document.body.scrollTop
	else
	{/*Netscape stuff*/}
	//alert(diffY);
	percent=.1*(diffY-lastScrollY); 
	if(percent>0)percent=Math.ceil(percent); 
	else percent=Math.floor(percent); 
	document.getElementById("lovexin12").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	document.getElementById("lovexin14").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	lastScrollY=lastScrollY+percent; 
	//alert(lastScrollY);
}

if(!isMobileBrowser()){
		//suspendcode12="<DIV id=\"lovexin12\" style='width:120px;height:270px;left:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://bbs.huaweicloud.com/forum/thread-16526-1-1.html' target='_blank'><img src='./images/couplets/hw_cp_20190411_01.png'/></a></div>"
		//suspendcode14="<DIV id=\"lovexin14\" style='width:120px;height:270px;right:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://activity.huaweicloud.com/2019june_promotion/index.html?utm_source=huawei&utm_medium=other&utm_campaign=618dacu&utm_content=0614#app-connection' target='_blank'><img src='./images/couplets/hw_cp_20190612.png'/></a></div>"
		//document.write(suspendcode12); 
		//document.write(suspendcode14); 
		//window.setInterval("heartBeat()",1);
}

$(document).ready(function(){ 
	
});
</script>
