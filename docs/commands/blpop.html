<!DOCTYPE html>
<html>
	<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="/css/styles.css?1436966512">
    <link rel="stylesheet" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href='./images/favicon.png' rel='shortcut icon' />
    <meta content='width=device-width, minimum-scale=1.0, maximum-scale=1.0' name='viewport' />
    <title>blpop 命令 -- Redis中国用户组（CRUG）</title>
    <meta name="description" content="redis
">
		<script src='./js/jquery-2.0.3.min.js?1426205838'></script>
		<script src='./js/slideout.js?1426205838'></script>
		<script src='./js/app.js?1436878127'></script>
		<script src='./js/base.js?1436878127'></script>
  </head>

<body class=''>
    <div class='mobile-menu slideout-menu'>
      <header class='menu-header'></header>
      <section class='menu-section'>
        <ul class='menu-section-list'>
          <li>
            <a class='home' src='/'>首页</a>
          </li>
          <li>
            <a href='./commands.html'>命令</a>
          </li>
          <li>
            <a href='./clients.html'>客户端</a>
          </li>
          <li>
            <a href='./documentation.html'>文档</a>
          </li>
          <li>
            <a href='./community.html'>社区</a>
          </li>
          <li>
            <a href='./download.html'>下载</a>
          </li>
          <li>
            <a href='./support.html'>支持</a>
          </li>
          <li>
            <a href='./topics/license.html'>许可</a>
          </li>
          <li>
            <a href='./update.html'>更新日志</a>
          </li>
          <li>
            <a href='./articles.html'>文章大全</a>
          </li>
		  <li>
            <a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </li>
          
        </ul>
      </section>
    </div>
    <div class='site-wrapper'>
      <header class='site-header'>
        <nav class='container'>
          <div class='mobile-header'>
            <button class='btn-hamburger js-slideout-toggle'>
              <span class='fa fa-bars'></span>
            </button>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
          </div>
          <div class='desktop-header'>
            <a class='home' src='/'>
              <img alt='Redis' src='./images/redis-white.png' />
            </a>
            <a href='./commands.html'>命令</a>
            <a href='./clients.html'>客户端</a>
            <a href='./documentation.html'>文档</a>
            <a href='./community.html'>社区</a>
            <a href='./download.html'>下载</a>
            <a href='./support.html'>支持</a>
            <a href='./topics/license.html'>许可</a>
            <a href='./update.html'>更新日志</a>
            <a href='./articles.html'>文章大全</a>
			<a href='http://bbs.redis.cn' target='_blank'>论坛</a>
          </div>
        </nav>
      </header>
      <header class='site-header' style="background-color: #ffffff;">
        <!--
        <nav class='container'>
        	<a href="https://activity.huaweicloud.com/support_plan/index.html?utm_source=huawei&utm_medium=banner&utm_campaign=armredis&utm_content=0624&utm_term=crug" target="_blank">
				<img src="./images/bn/huawei_redis_08.png" style="width:100%;"/>
			</a>
        </nav>
      -->
      </header>
      <div class='site-content'>

<div class='text'>
          <h1 class='command'>
            <span class='name'></span>
            <span class='arg'></span>
          </h1>
          <article>
            <div class='article-main'>
              <div class='metadata'>
              </div>
              <p><a href="/commands/blpop.html">BLPOP</a> 是阻塞式列表的弹出原语。 它是命令 <a href="/commands/lpop.html">LPOP</a> 的阻塞版本，这是因为当给定列表内没有任何元素可供弹出的时候， 连接将被 <a href="/commands/blpop.html">BLPOP</a> 命令阻塞。 当给定多个 key 参数时，按参数 key 的先后顺序依次检查各个列表，弹出第一个非空列表的头元素。</p>

<h2 id="非阻塞行为">非阻塞行为</h2>

<p>当 <a href="/commands/blpop.html">BLPOP</a> 被调用时，如果给定 key 内至少有一个非空列表，那么弹出遇到的第一个非空列表的头元素，并和被弹出元素所属的列表的名字 key 一起，组成结果返回给调用者。</p>

<p>当存在多个给定 key 时， BLPOP 按给定 key 参数排列的先后顺序，依次检查各个列表。 我们假设 key list1 不存在，而 list2 和 list3 都是非空列表。考虑以下的命令：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BLPOP list1 list2 list3 0
</code></pre></div></div>

<p>BLPOP 保证返回一个存在于 list2 里的元素（因为它是从 list1 –&gt; list2 –&gt; list3 这个顺序查起的第一个非空列表）。</p>

<h2 id="阻塞行为">阻塞行为</h2>

<p>如果所有给定 key 都不存在或包含空列表，那么 <a href="/commands/blpop.html">BLPOP</a> 命令将阻塞连接， 直到有另一个客户端对给定的这些 key 的任意一个执行 <a href="/commands/lpush.html">LPUSH</a> 或 <a href="/commands/rpush.html">RPUSH</a> 命令为止。</p>

<p>一旦有新的数据出现在其中一个列表里，那么这个命令会解除阻塞状态，并且返回 key 和弹出的元素值。</p>

<p>当 <a href="/commands/blpop.html">BLPOP</a> 命令引起客户端阻塞并且设置了一个非零的超时参数 timeout 的时候， 若经过了指定的 timeout 仍没有出现一个针对某一特定 key 的 push 操作，则客户端会解除阻塞状态并且返回一个 nil 的多组合值(multi-bulk value)。</p>

<p><strong>timeout 参数表示的是一个指定阻塞的最大秒数的整型值。</strong>当 timeout 为 0 是表示阻塞时间无限制。</p>

<h2 id="什么-key-会先被处理是什么客户端什么元素优先顺序细节">什么 key 会先被处理？是什么客户端？什么元素？优先顺序细节。</h2>

<ul>
  <li>当客户端为多个 key 尝试阻塞的时候，若至少存在一个 key 拥有元素，那么返回的键值对(key/element pair)就是从左到右数第一个拥有一个或多个元素的key。 在这种情况下客户端不会被阻塞。比如对于这个例子 BLPOP key1 key2 key3 key4 0，假设 key2 和 key4 都非空， 那么就会返回 key2 里的一个元素。</li>
  <li>当多个客户端为同一个 key 阻塞的时候，第一个被处理的客户端是等待最长时间的那个（即第一个因为该key而阻塞的客户端）。 一旦一个客户端解除阻塞那么它就不会保持任何优先级，当它因为下一个 BLPOP 命令而再次被阻塞的时候，会在处理完那些 被同个 key 阻塞的客户端后才处理它（即从第一个被阻塞的处理到最后一个被阻塞的）。</li>
  <li>当一个客户端同时被多个 key 阻塞时，若多个 key 的元素同时可用（可能是因为事务或者某个Lua脚本向多个list添加元素）， 那么客户端会解除阻塞，并使用第一个接收到 push 操作的 key（假设它拥有足够的元素为我们的客户端服务，因为有可能存在其他客户端同样是被这个key阻塞着）。 从根本上来说，在执行完每个命令之后，Redis 会把一个所有 key 都获得数据并且至少使一个客户端阻塞了的 list 运行一次。 这个 list 按照新数据的接收时间进行整理，即是从第一个接收数据的 key 到最后一个。在处理每个 key 的时候，只要这个 key 里有元素， Redis就会对所有等待这个key的客户端按照“先进先出”(FIFO)的顺序进行服务。若这个 key 是空的，或者没有客户端在等待这个 key， 那么将会去处理下一个从之前的命令或事务或脚本中获得新数据的 key，如此等等。</li>
</ul>

<h2 id="当多个元素被-push-进入一个-list-时-blpop-的行为">当多个元素被 push 进入一个 list 时 BLPOP 的行为</h2>

<p>有时候一个 list 会在同一概念的命令的情况下接收到多个元素：</p>

<ul>
  <li>像 LPUSH mylist a b c 这样的可变 push 操作。</li>
  <li>在对一个向同一个 list 进行多次 push 操作的 MULTI 块执行完 EXEC 语句后。</li>
  <li>使用 Redis 2.6 或者更新的版本执行一个 Lua 脚本。</li>
</ul>

<p>当多个元素被 push 进入一个被客户端阻塞着的 list 的时候，Redis 2.4 和 Redis 2.6 或者更新的版本所采取行为是不一样的。</p>

<p>对于 Redis 2.6 来说，所采取的行为是先执行多个 push 命令，然后在执行了这个命令之后再去服务被阻塞的客户端。看看下面命令顺序。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Client A:   BLPOP foo 0
Client B:   LPUSH foo a b c
</code></pre></div></div>

<p>如果上面的情况是发生在 Redis 2.6 或更高版本的服务器上，客户端 A 会接收到 c 元素，因为在 <a href="/commands/lpush.html">LPUSH</a> 命令执行后，list 包含了 c,b,a 这三个元素，所以从左边取一个元素就会返回 c。</p>

<p>相反，Redis 2.4 是以不同的方式工作的：客户端会在 push 操作的上下文中被服务，所以当 LPUSH foo a b c 开始往 list 中 push 第一个元素，它就被传送给客户端A，也就是客户端A会接收到 a（第一个被 push 的元素）。</p>

<p>Redis 2.4的这种行为会在复制或者持续把数据存入AOF文件的时候引发很多问题，所以为了防止这些问题，很多更一般性的、并且在语义上更简单的行为被引入到 Redis 2.6 中。</p>

<p>需要注意的是，一个Lua脚本或者一个 <a href="/commands/multi.html">MULTI</a> / <a href="/commands/exec.html">EXEC</a> 块可能会 push 一堆元素进入一个 list 后，再 删除这个 list。 在这种情况下，被阻塞的客户端完全不会被服务，并且只要在执行某个单一命令、事务或者脚本后 list 中没有出现元素，它就会被继续阻塞下去。</p>

<h2 id="在一个-multi--exec-事务中的-blpop">在一个 MULTI / EXEC 事务中的 BLPOP</h2>

<p><a href="/commands/blpop.html">BLPOP</a> 可以用于流水线（pipeline，发送多个命令并且批量读取回复），特别是当它是流水线里的最后一个命令的时候，这种设定更加有意义。</p>

<p>在一个 <a href="/commands/multi.html">MULTI</a> / <a href="/commands/exec.html">EXEC</a> 块里面使用 <a href="/commands/blpop.html">BLPOP</a> 并没有很大意义，因为它要求整个服务器被阻塞以保证块执行时的原子性，这就阻止了其他客户端执行一个 push 操作。 因此，一个在 <a href="/commands/multi.html">MULTI</a>  / <a href="/commands/exec.html">EXEC</a> 里面的 <a href="/commands/blpop.html">BLPOP</a> 命令会在 list 为空的时候返回一个 <code class="language-plaintext highlighter-rouge">nil</code> 值，这跟超时(timeout)的时候发生的一样。</p>

<p>如果你喜欢科幻小说，那么想象一下时间是以无限的速度在 MULTI / EXEC 块中流逝……</p>

<h2 id="返回值">返回值</h2>

<p><a href="/topics/protocol.html#multi-bulk-reply">多批量回复(multi-bulk-reply)</a>: 具体来说:</p>

<ul>
  <li>当没有元素的时候会弹出一个 nil 的多批量值，并且 timeout 过期。</li>
  <li>当有元素弹出时会返回一个双元素的多批量值，其中第一个元素是弹出元素的 key，第二个元素是 value。</li>
</ul>

<h2 id="例子">例子</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis&gt; DEL list1 list2
(integer) 0
redis&gt; RPUSH list1 a b c
(integer) 3
redis&gt; BLPOP list1 list2 0
1) "list1"
2) "a"
</code></pre></div></div>

<h2 id="可靠的队列">可靠的队列</h2>

<p>当 <a href="/commands/blpop.html">BLPOP</a> 返回一个元素给客户端的时候，它也从 list 中把该元素移除。这意味着该元素就只存在于客户端的上下文中：如果客户端在处理这个返回元素的过程崩溃了，那么这个元素就永远丢失了。</p>

<p>在一些我们希望是更可靠的消息传递系统中的应用上，这可能会导致一些问题。在这种时候，请查看 <a href="/commands/brpoplpush.html">BRPOPLPUSH</a> 命令，这是 <a href="/commands/blpop.html">BLPOP</a> 的一个变形，它会在把返回元素传给客户端之前先把该元素加入到一个目标 list 中。</p>

<h2 id="模式事件提醒">模式：事件提醒</h2>

<p>用来阻塞 list 的操作有可能是不同的阻塞原语。 比如在某些应用里，你也许会为了等待新元素进入 Redis Set 而阻塞队列，直到有个新元素加入到 Set 中，这样就可以在不轮询的情况下获得元素。 这就要求要有一个 <a href="/commands/spop.html">SPOP</a> 的阻塞版本，而这事实上并不可用。但是我们可以通过阻塞 list 操作轻易完成这个任务。</p>

<p>消费者会做的：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LOOP forever
    WHILE SPOP(key) returns elements
        ... process elements ...
    END
    BRPOP helper_key
END
</code></pre></div></div>

<p>而在生产者这角度我们可以这样简单地使用：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MULTI
SADD key element
LPUSH helper_key x
EXEC
</code></pre></div></div>

            </div>
			<div class='article-aside'>
              <aside>
                <h2>
                  相关命令
                </h2>
                <ul>
                  <li>
                    <a src='./commands/blpop.html'>
                      BLPOP
                    </a>
                  </li>
                  <li>
                    <a src='./commands/brpop.html'>
                      BRPOP
                    </a>
                  </li>
                  <li>
                    <a src='./commands/brpoplpush.html'>
                      BRPOPLPUSH
                    </a>
                  </li>
                  <li>
                    <a src='./commands/lindex.html'>
                      LINDEX
                    </a>
                  </li>
                  <li>
                    <a src='./commands/linsert.html'>
                      LINSERT
                    </a>
                  </li>
                  <li>
                    <a src='./commands/llen.html'>
                      LLEN
                    </a>
                  </li>
                  <li>
                    <a src='./commands/lpop.html'>
                      LPOP
                    </a>
                  </li>
                  <li>
                    <a src='./commands/lpush.html'>
                      LPUSH
                    </a>
                  </li>
                  <li>
                    <a src='./commands/lpushx.html'>
                      LPUSHX
                    </a>
                  </li>
                  <li>
                    <a src='./commands/lrange.html'>
                      LRANGE
                    </a>
                  </li>
                  <li>
                    <a src='./commands/lrem.html'>
                      LREM
                    </a>
                  </li>
                  <li>
                    <a src='./commands/lset.html'>
                      LSET
                    </a>
                  </li>
                  <li>
                    <a src='./commands/ltrim.html'>
                      LTRIM
                    </a>
                  </li>
                  <li>
                    <a src='./commands/rpop.html'>
                      RPOP
                    </a>
                  </li>
                  <li>
                    <a src='./commands/rpoplpush.html'>
                      RPOPLPUSH
                    </a>
                  </li>
                  <li>
                    <a src='./commands/rpush.html'>
                      RPUSH
                    </a>
                  </li>
                  <li>
                    <a src='./commands/rpushx.html'>
                      RPUSHX
                    </a>
                  </li>
                </ul>
                </ul>
              </aside>
            </div>
            </article>
            
</div>
<script>
		if(isRediscnPc()){
			var s = "_" + Math.random().toString(36).slice(2);
			document.write('<div style="margin-bottom:10px;" id="' + s + '"></div>');
			(window.slotbydup = window.slotbydup || []).push({
				id: "u3556359",
				container:  s
			});
			document.write('<scr'+'ipt type="text/javascr'+'ipt" src="//cpro.baidustatic.com/cpro/ui/c.js" async="async" defer="defer" ></scr'+'ipt>');
		}
	
</script>
	

<div id='disqus_thread' style="border:1px solid #CDCDCD;background-color:#CDCDCD;"></div>
      <script type='text/javascript'>
      $(document).ready(function(){ 
      		$.get("http://bbs.redis.cn/forum.php?mod=viewthread1&tid=909", function(result){
				    $("#disqus_thread").html(result);
				  });
      });
      </script>
</div>

<footer class='site-footer'>
        <div class='container'>
          本站资源翻译自<a href="http://redis.io" target="_blank">redis.io</a>，
					由<a src="./aboutus.html">redis.cn翻译团队</a>翻译，
					更新日志请点击<a src="./update.html">这里</a>查看，
					翻译原文版权归redis.io官方所有，翻译不正确的地方欢迎大家指出。<br> 
					感谢各界爱心人士的热心捐赠，CRUG的成长离不开大家的帮助和支持，特别是<a src="./donation.html">Redis捐赠清单</a>里面的各位伙伴。<br>
					联系Email:<a href="mailto:admin@redis.cn">admin@redis.cn</a>，
					redis交流群：<a href="#">579708237</a> &nbsp; 
					<a href="https://beian.miit.gov.cn" target="_blank">京ICP备15003959号-2</a> &nbsp;
					<script src='http://s22.cnzz.com/stat.php?id=3593514&web_id=3593514' language='JavaScript'></script>
					<br>    
					<span style="font-weight:bold;color:#000000;">友情链接：</span>
					<a href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=fvilu0rm" target="_blank">阿里云</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">DBA的罗浮宫</a> &nbsp;
					<a href="http://mdba.cn" target="_blank">VIP-陈群博客</a> &nbsp;
					<a href="http://lib.csdn.net/base/redis" target="_blank">Redis-知识库</a> &nbsp;
					<a href="http://www.kubernetes.org.cn" target="_blank" >Kubernetes</a> &nbsp;	
					<a href="https://www.fanghouguo.com" target="_blank" >方后国的博客</a> &nbsp;	
					<a href="https://aff.gae1s.com/aff.php?aff=10022" target="_blank" >ChromeGAE</a> &nbsp;	
					<a href="http://top.chinaz.com/" target="_blank" >网站排行榜</a> &nbsp;	
        </div>
      </footer>
    </div>
  </body>
</html>


<script>
	if(!isMobileBrowser()){
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"54.5"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	}
</script>

<script type='text/javascript'>
lastScrollY=0;

function heartBeat(){ 
	var diffY;
	if (document.documentElement && document.documentElement.scrollTop)
	diffY = document.documentElement.scrollTop;
	else if (document.body)
	diffY = document.body.scrollTop
	else
	{/*Netscape stuff*/}
	//alert(diffY);
	percent=.1*(diffY-lastScrollY); 
	if(percent>0)percent=Math.ceil(percent); 
	else percent=Math.floor(percent); 
	document.getElementById("lovexin12").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	document.getElementById("lovexin14").style.top=parseInt(document.getElementById
	("lovexin12").style.top)+percent+"px";
	lastScrollY=lastScrollY+percent; 
	//alert(lastScrollY);
}

if(!isMobileBrowser()){
		//suspendcode12="<DIV id=\"lovexin12\" style='width:120px;height:270px;left:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://bbs.huaweicloud.com/forum/thread-16526-1-1.html' target='_blank'><img src='./images/couplets/hw_cp_20190411_01.png'/></a></div>"
		//suspendcode14="<DIV id=\"lovexin14\" style='width:120px;height:270px;right:2px;POSITION:absolute;TOP:320px;z-index:3;'><a href='https://activity.huaweicloud.com/2019june_promotion/index.html?utm_source=huawei&utm_medium=other&utm_campaign=618dacu&utm_content=0614#app-connection' target='_blank'><img src='./images/couplets/hw_cp_20190612.png'/></a></div>"
		//document.write(suspendcode12); 
		//document.write(suspendcode14); 
		//window.setInterval("heartBeat()",1);
}

$(document).ready(function(){ 
	
});
</script>

<script src='/js/commands.js?1426205833'></script>